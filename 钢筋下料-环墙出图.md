# 钢筋下料-环墙出图

## 优化#环形墙整合出图

初始：环形墙需要被分为多个弧形墙出图。

目标：环形墙单独出单图。

线索：

环形墙继承自弧形墙，并重写CreateWallTemGraph、GetWallArcPoints、CreateArcDgnMode、GetRebarInfo、CreateArcWallAngleRule、DimHolesAngleARC2、AddAllRebarLinesToDgnModel。

注意：

主要在配筋时就需要决定是否断开环墙，此时就可以确定出图的数量。

CreateWallTemGraph中提到多个重写的函数，例如**创建，更新，刷新**。

环形墙出图完整出图有误，无钢筋，弧度尺刻度只有180-230.

环形被分为了32份直线

S1：将默认的0-360°出图修复

S2：无论断开几次，都在最后的二维图拼接

当前无法切出圆心角大于180°的弧形墙，自然不可能直接出360°的环墙。先查出为何不可。

S21：环形墙使用更多的自定义函数，拼接钢筋长度，模型各参数

必须要在标注之前就确定所有的钢筋和墙

S3：独立的环形墙逻辑，将相邻的弧形按照首位拼接，最后进行统一处理

内弧部分保存在投影ProjectFace结构中的正面部分，外弧保存在背面部分

GetWallsAndFloorsDescrP花费巨量时间

圆的周长：C=2πr

计算投影面时，有重复计算，争取消除重复。（直接采用最后一个，将作为圆）

2025年1月9日

找到钢筋存储的位置以及拼接处理位置

在AddAllRebarLinesToDgnModel中找

通过将每个循环中的m_inarc存储为m_inarcAll最后一次性使用，基本能够完成钢筋的绘制，但是部分拼接位置存在重叠或稀疏

2025年1月10日

尝试将完整的环墙出图

在GetSelectArcWallDatas中没有成功区分起止点，导致弧度为0

后续的扫描也只在这一小片范围内在扫描，实际并没有任何钢筋在该范围

ArcRebarProjection中判断钢筋与投影面距离，~~距离过远则不录入~~（考虑到环形钢筋，可能应该要更换为必须有靠近投影面才录入）

newShapeEeh为扩大后的投影面，lineEeh是复制出的钢筋描述符

2025年1月13日

成功为3BRX0402VB出图。

其余构件无法获取到钢筋，此为原始存在的问题。

Bug：360°出图中的轮廓图丢失孔洞信息

2025年1月14日

Bug1：“概率性”起止弧度错误，不调试的情况下为180-232左右，调试则可能为0-360，有视频为证。

修复1：环墙重写GetArcWallDatas，手动保证360弧度正确。



Bug2：ArcRebarProjection如果遇到环墙，会产生对面的投影，表现为在遇到缺口环墙的情况下，轮廓图缺口会有钢筋。

措施2：

​	打印投影面对应的钢筋信息，如果环钢筋也可以找到跟距离有关的参数，则尝试排除。

修复2：根据当前投影面位置，找到钢筋线最近点，并只取至多占总长三分之一的周围边缘做投影



Bug3：某些构件在调试的情况下，无法获取到钢筋信息。

分析3：已知判断钢筋有效的方式为：首先根据内外弧绘制弧形构件区域边界，连接内外弧和起止点的两条直线创建封闭形状。遍历所有钢筋并判断钢筋是否在区域内，一般起点和终点都会在区域内。错因3：异常构件的内外弧半径相同，在GetEllipseDownFace时没有取到底面弧元素组。通过将封装的代码取出并调试，确认查明为模型问题，出图环墙构件的差集元素中必须要有一个贴合内经且属性Type为NEG的圆柱体，否则无法得到环墙内弧半径，进而导致无法处理钢筋。



Bug4：二维图中的钢筋线因为创建为复杂链，会导致缺口被连接

措施4：在论坛提问，待回复

间隔超过一定区间，则分为多条线，存入同一个descr

先进行合并，不可合并再进行拼接

根据首尾信息等，判断是否可以合并

尝试使用next链式连接，但是无法绘制，待查明

复杂链的默认大小是极大和极小

修复4：使用复杂链合并相交的钢筋线，如果不相交就结束复杂链，创建新的复杂链拼接到原复杂链后方。在绘制时遍历复杂链描述符链表进行逐个绘制。



Bug5：链式结构无法完全赋予钢筋属性以及标注，需要逐个赋予。后续可能会有与套管相关的Bug。

措施5：尝试作为单元，但是在添加套筒时会出现错误。

尝试单独留下标注，但是rebar需要单独的二维钢筋id

修复5：为每一根钢筋记录钢筋组中对应的二维钢筋范围，一根多段则调整二维钢筋范围，保证一一对应



Bug6：CreateAllDash_New绘制轮廓图似乎也存在投影问题，重复了孔洞

分析6：在Addwallbacktomodel绘制轮廓线，在GetArcAllFacesDataARC计算轮廓线

在ProjectArcWallsToMidFace将切面投影到投影面上

措施6：计划在投影时计算与投影面距离，超过半径则不投影

修复6：利用环墙的圆心作为参考点，计算元素相对于投影面的中心角度，并根据角度范围(±90°)筛选需要投影的元素。如果元素到圆心的向量与投影面中点到圆心的向量点积小于0，说明角度大于90°，不投影。（PS：钢筋不可以这么做，因为环形钢筋）



Bug7：背面钢筋标注位置错误。部分投影片段并没有将三维中的钢筋映射到二维，导致部分标注坐标按照三维的xy排列。

解决7：使用专门的背面出图配置参数



Bug8：横向钢筋因为投影产生精度偏差

措施8：在绘制后，根据钢筋的起止弧度，重新计算长度，替换原来的元素，需要保证与标注等信息的绑定。

问题8：实际的轮廓图宽度和钢筋横向长度都是投影面的周长，钢筋因为投影面在投射钢筋时扩大了30单位，所以左右各长30mm，可能需要将轮廓图以及钢筋均横向按比例拉伸，

修复8：需要在合理的弧度内将钢筋回复到原来的长度产生了悖论，不可能在保证相对弧度还有绝对长度。仅处理30mm，在环形墙钢筋投影的第一次和最后一次时不将投影面扩大30mm。



Bug9：竖向钢筋因为投影产生重复

措施9：根据钢筋所在的弧度位置，排除一定范围内重复的竖向钢筋。

修复9：在钢筋投影时，比较投影前后的长度，如果长度相同，基本确定为直的钢筋，并标记为已投影，在其他区域发现已投影钢筋时不再投影。



Bug10：环墙钢筋排版图，出图崩溃

分析10：使用4.0.9新版本配筋，在任何AddToModel时发送崩溃。

措施10：尝试生成旧版的配筋dll，使用旧版dll配筋，争取实现1断配筋

解决10：注册表路径错误C:\ProgramData\\CGNCivilRebar\。有多余的斜线，导入文字样式失败，使用不存在的文字样式导致崩溃。在拼接路径时修复并检测路径。



Bug11：墙钢筋排版图，出图套筒丢失

分析11：原先的修改将所有的直钢筋套筒清空。弧形钢筋读取的结构和配筋时写入的结构体不一致。

解决11：注释第一部分。修改结构体string为char[516]



Bug12：环形墙出图竖直钢筋首尾套筒错换

分析12：钢筋线实际起止点为从上至下，套筒起止点为从下至上。测试是否仅有环形钢筋线起止点有此情况。弧形也是这样。了解是否配筋时就特殊处理此类钢筋。考虑如果钢筋方向竖直向下就反转首尾套筒。

依据钢筋以及方向，则需要计算起止点和起止方向。

依据套筒，则需要调换套筒类型。

解决12：依据大致方向以及长度，不处理X长于Y跨度的以及Y方向相同的。将起止点和起止方向互换。



Bug13：环墙背面出图钢筋位置不对

解决13：内外侧投影钢筋都是对m_inarc.map_labelInfoTol操作，内侧已经设为已投影则外侧不再投影。内侧处理后重新初始化已投影参数isProjection=0即可。

