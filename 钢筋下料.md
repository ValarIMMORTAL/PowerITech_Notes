# 钢筋下料

## 优化#环形墙整合出图

初始：环形墙需要被分为多个弧形墙出图。

目标：环形墙单独出单图。

线索：

环形墙继承自弧形墙，并重写CreateWallTemGraph、GetWallArcPoints、CreateArcDgnMode、GetRebarInfo、CreateArcWallAngleRule、DimHolesAngleARC2、AddAllRebarLinesToDgnModel。

注意：

主要在配筋时就需要决定是否断开环墙，此时就可以确定出图的数量。

CreateWallTemGraph中提到多个重写的函数，例如**创建，更新，刷新**。

环形墙出图完整出图有误，无钢筋，弧度尺刻度只有180-230.

环形被分为了32份直线

S1：将默认的0-360°出图修复

S2：无论断开几次，都在最后的二维图拼接

当前无法切出圆心角大于180°的弧形墙，自然不可能直接出360°的环墙。先查出为何不可。

S21：环形墙使用更多的自定义函数，拼接钢筋长度，模型各参数

必须要在标注之前就确定所有的钢筋和墙

S3：独立的环形墙逻辑，将相邻的弧形按照首位拼接，最后进行统一处理

内弧部分保存在投影ProjectFace结构中的正面部分，外弧保存在背面部分

GetWallsAndFloorsDescrP花费巨量时间

圆的周长：C=2πr

计算投影面时，有重复计算，争取消除重复。（直接采用最后一个，将作为圆）

2025年1月9日

找到钢筋存储的位置以及拼接处理位置

在AddAllRebarLinesToDgnModel中找

通过将每个循环中的m_inarc存储为m_inarcAll最后一次性使用，基本能够完成钢筋的绘制，但是部分拼接位置存在重叠或稀疏

2025年1月10日

尝试将完整的环墙出图

在GetSelectArcWallDatas中没有成功区分起止点，导致弧度为0

后续的扫描也只在这一小片范围内在扫描，实际并没有任何钢筋在该范围

ArcRebarProjection中判断钢筋与投影面距离，~~距离过远则不录入~~（考虑到环形钢筋，可能应该要更换为必须有靠近投影面才录入）

newShapeEeh为扩大后的投影面，lineEeh是复制出的钢筋描述符

2025年1月13日

成功为3BRX0402VB出图。

其余构件无法获取到钢筋，此为原始存在的问题。

Bug：360°出图中的轮廓图丢失孔洞信息

2025年1月14日

Bug1：“概率性”起止弧度错误，不调试的情况下为180-232左右，调试则可能为0-360，有视频为证。

修复1：环墙重写GetArcWallDatas，手动保证360弧度正确。

Bug2：ArcRebarProjection如果遇到环墙，会产生对面的投影，表现为在遇到缺口环墙的情况下，轮廓图缺口会有钢筋。

措施2：

​	打印投影面对应的钢筋信息，如果环钢筋也可以找到跟距离有关的参数，则尝试排除。

修复2：根据当前投影面位置，找到钢筋线最近点，并只取至多占总长三分之一的周围边缘做投影

Bug3：某些构件在调试的情况下，无法获取到钢筋信息。

措施3：不调试，打印钢筋信息到日志中。

Bug4：二维图中的钢筋线因为创建为复杂链，会导致缺口被连接

措施4：在论坛提问，待回复