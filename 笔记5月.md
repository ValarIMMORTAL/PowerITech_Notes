# 笔记5月

## 2025年5月6日

修改软著文件

企口墙竖直钢筋

### 2025年5月6日13:59:16

企口墙竖直墙单独可配置钢筋直径，需要在界面上增加控制按钮，目前只用固定的值来配置，在完成企口位置横筋后再考虑

无法通过局部的值来完成企口位置和主体位置的单独钢筋配置，在将钢筋点转化为钢筋元素时，只会采用当前barlines对应的直径配置，而企口配置归属于已有的主题配置。

如果仅有直径配置，则需要在所有调用直径的位置为企口钢筋而进行修改，比如在为企口位置的钢筋点数据生成钢筋元素时，需要单独识别出企口竖直钢筋和横筋。



### 2025年5月6日16:25:58

问题1：竖直钢筋端部有裸露

问题2：企口墙横向钢筋

问题3：企口墙竖向横向钢筋直径配置



## 2025年5月7日

问题2：企口墙横向钢筋

问题3：企口墙竖向横向钢筋直径配置

### 2025年5月7日09:17:42

分析：

1. 需要保证在最低顶面之下，点筋能够保持水平。
2. 如果有企口侧面最低点在最低顶面，则需要从其附近的点筋水平布置钢筋。
3. 企口顶端点筋单独在中间。

整理：

目前的配筋逻辑，首先确定路径，基线，间距，再根据基线在路径上逐渐移动间距距离创建完整的钢筋点。

方案1：

1. 路径在最高顶面范围内，则可能是左右的单边企口墙，取最低顶面的Z坐标对路径进行划分。划分后的顶面在最上方。
2. 路径不在最高顶面范围内，则可能是中间的双边企口墙，或者单边企口墙一侧。把路径上限限制在Z坐标内，并将企口顶端侧面加入配筋

### 2025年5月7日17:57:32

即使勉强在企口竖直面配置了点筋，但是间距仍然难以控制，同时原来的竖直面以为底面的斜率，无法和企口竖直面的点筋平行。



## 2025年5月8日

问题1：企口竖直顶端钢筋裸露

问题2：企口墙横向钢筋

问题3：企口墙竖向横向钢筋直径配置

### 2025年5月8日11:51:10

顶端的位置在企口开洞内，不在之前考虑的孔洞避让逻辑内，所以无效。企口位置的竖直钢筋锚固可能得要在处理企口锚固的位置单独进行处理，左右各移动锚固一定距离判断墙体方向（锚固半径/两个保护层/一半墙厚度）考虑到顶部尖端位置，可能用锚固半径更合适。

### 2025年5月8日13:44:42

考虑到钢筋直径会影响锚固半径，决定用两个保护层的距离

### 2025年5月8日17:04:36

勉强完成企口墙横向钢筋

需要调整企口位置横竖钢筋直径以适应窄的企口端部

需要增加界面上的配置

找到可以修改直径的位置，目前包括但不限于调整位置时，根据钢筋点生成钢筋元素时。

### 2025年5月8日18:54:02

侧面都是凹凸的，会导致部分位置没有横筋



## 2025年5月9日

问题2：企口墙横向钢筋

问题3：企口墙竖向横向钢筋直径配置

### 2025年5月9日09:49:13

基本完成企口横向钢筋和直径配置

需要增加用户界面

高低企口需要补充横筋



## 2025年5月12日

### 2025年5月12日16:27:36

完成用户界面修改企口直径的功能

三层高低企口补充中间层的水平配筋

企口位置不处理钢筋端部样式为孔洞锚固

接下来尝试在多个位置测试配筋情况，尽可能符合图纸



## 2025年5月13日

同一面墙配筋时替换已经存在的钢筋

横向钢筋水平放置

企口墙顶端钢筋位置调整

墙配筋底部部分钢筋被截断

### 2025年5月13日13:43:57

同一面墙配筋时替换已经存在的钢筋

### 2025年5月13日15:05:34

经过与客户交流，墙的水平钢筋可以直接使用绝对水平，不使用延边路径，需要在边缘提前截断。

基本可以达成水平钢筋的构建，但是底部扩展到板的钢筋一端仍然接近裸露的情况

### 2025年5月13日17:33:28

板存在应对异形边缘的情况，即是得到基础线偏移的钢筋起止点后，使用GetIntersectPointsWithOldElm和GetIntersectPointsWithSlabRebar得到rebarSegments交点，此时钢筋起止点基本能够符合保护层范围。

但是墙在rebarSegments之后，还有应对周围墙板而进行的延伸，导致失去了这种特性，无法在这种倾斜异形的情况下控制钢筋与保护层的距离。

### 2025年5月13日17:54:25

应对在周围墙板进行的延伸，且钢筋不遵循保护层规范的问题

方案1：按沿边路径的最高点进行基础钢筋，虽然地处空闲较大，但是起码不会出现保护层的极端情况。而且斜率一般较小，影响范围较小。

方案2：争取在makeRebarCurve中，将延伸到板的钢筋再与板进行GetIntersectPointsWithOldElm和GetIntersectPointsWithSlabRebar得到rebarSegments交点的操作，兴许可以得到最佳效果。



## 2025年5月14日

墙配筋横筋保持水平

### 2025年5月14日11:29:17

方案3：采取偏移策略，如果水平钢筋接近边缘点，则仿造异形板边缘钢筋处理，提前截断

先尝试手动修改钢筋偏移后的位置，能否截断到合适位置

经过尝试后，直接在makeRebarCurve进入后，就修改钢筋位置，即可得到合理提前截断在保护层位置内的钢筋线，需要偏移的距离为保护层加半径，最后还原即可。

### 2025年5月14日17:56:51

方案3经过优化后，在ReCalExtendDisByTopDownFloor进行偏移操作，需要控制影响的范围，比如目前只控制水平钢筋



## 2025年5月15日

墙配筋横筋保持水平

### 2025年5月15日11:10:06

边缘钢筋基本可以合理的截断，但是在墙板之间的横筋，无论和墙板单独做交都只能拿到其中一部分的长度，无法得到墙板合一的效果。

此种钢筋要么视为在结构内，应该能够将墙板视为一个构件进行延伸。要么视为只在主结构内，提前截断

### 2025年5月15日16:57:09

水平钢筋暂时保持处理情况

单面企口墙顶端水平钢筋和U型钢筋冲突

### 2025年5月15日17:59:31

可能是没有在顶部加入偏移



## 2025年5月16日

1. 单面企口墙顶端水平钢筋和U型钢筋冲突
2. 同样厚度的底板，两面墙规划的配筋数量却不同

### 2025年5月16日13:52:39

1. 单面企口墙在顶端水平钢筋确定在U型钢筋内时，终端多偏移一个fdiam之前所有钢筋的直径即可
2. 顶底板的位置判断和厚度计算被修改过，有顶板可能被规划到底板导致底板厚度薄于真正的底板而钢筋数量有问题。

接下来：

给大部分电缆沟进行配筋，与图纸比较

## 2025年5月16日17:03:29

企口墙如果顶面周围有板，可能会当做上方有板而错误的扩展配筋。需要在顶底板增加判断逻辑，不在墙上方的板不应该延伸。

解决思路：

起码板的Z轴极大点必须高于墙



## 2025年5月19日

企口墙墙配筋上部延伸到空处裸露

### 2025年5月19日13:40:26

在计算钢筋基础路线以及延伸时，记录上下延伸半个板厚度后的钢筋端点位置，如果板的最大最小Z在这个范围内说明板在墙外，可以延伸。

问题：

企口位置横筋没有锚固到孔洞截断，半直墙半企口会有钢筋锚固到其中，或是没有直锚到板中

解决：

弯锚改为U型钢筋条件需要修改，提前结束时即使是单面企口墙顶端也需要满足厚度不等于墙厚度

## 2025年5月19日15:55:13

剖断线优化：

连续的混泥土墙剖断线归为连续，有孔洞则断开

**优化 #85445**【核岛出图ABD】剖断线优化：在混凝土连续位置使用一段剖断线，若墙体被孔洞断开，使用多段剖断线

### 2025年5月19日18:03:01

ABD需要用黑窗口编译，而且核岛出图需要额外的dll



## 2025年5月20日

**优化 #85445**【核岛出图ABD】剖断线优化：在混凝土连续位置使用一段剖断线，若墙体被孔洞断开，使用多段剖断线

## 2025年5月20日14:14:01

分析CreateAllDash目前可知，由所有的元素确定极大极小范围，逐步处理上下左右剖断线。

将墙的边全部打散为线条，与极大极小范围进行比较，如果线条在边缘位置，则去除此墙边缘，并在该位置设定为可以生成剖断线。

在一面的剖断线计算完毕后，将相邻的剖断线拼接为更大的剖断线。最后将该面的剖断线全部绘制

### 2025年5月20日15:01:14

在CreateAllDash中并没有所有的孔洞信息，仅有当前选中墙的孔洞，需要找到所有孔洞

### 2025年5月20日16:54:39

可能在GetAllFacesData中就已经绘制了墙和孔洞。在里面发现了圆孔和方孔的处理痕迹以及添加到模型的操作

应该是在CombineProjectHolesWithDottedLine会将孔洞绘制，但是在三维中找不到对应ID的孔洞



## 2025年5月21日

**优化 #85445**【核岛出图ABD】剖断线优化：在混凝土连续位置使用一段剖断线，若墙体被孔洞断开，使用多段剖断线

### 2025年5月21日09:10:32

先取墙名称，从全局变量取CWall对应的map<string, IComponent*>，在结构体中，将IComponent强转为CWall就可以使用GetAllHoles得到孔洞。将孔洞Chole集合，判断类型GetPurpose

### 2025年5月21日15:21:52

被“flag怪”将上下墙孔洞的扫描进行了修改，撤除修改后，能够得到本体以及上下墙所有的孔洞套管埋件信息。

目前在GetAllFacesData中只将所有的方孔存储，考虑将方孔圆孔额外存储用于剖断线。

### 2025年5月21日16:02:17

CreateAllDash被多种墙和出图所引用，修改将影响较大的范围。

### 2025年5月21日18:00:50

目前考虑仅处理方孔优先，完成后再加入圆孔的处理

取默认最大的剖断线范围，并剔除遇到孔洞的部分，即可



## 2025年5月22日

**优化 #85445**【核岛出图ABD】剖断线优化：在混凝土连续位置使用一段剖断线，若墙体被孔洞断开，使用多段剖断线

### 2025年5月22日09:50:32

GraphCommon.cpp过于肥大，将其拆分为四个文件

处理孔洞与剖断线的关系，将孔洞描述符与剖断线范围作为起止点的直线求交点，将交点作为分割点

### 2025年5月22日14:11:03

使用mdlIntersect_allBetweenElms没有成功得到交点，可能需要其它配置

求剖断线时，孔洞元素已经被切割，范围勉强能接触边缘，可能相差0.1mm左右

误差值大小调整后，得到解决

### 2025年5月22日16:10:57

录制配筋出图流程演示视频



## 2025年5月26日

录制面配筋操作视频

剖断线处理

### 2025年5月26日09:13:05

目前可以成功切到孔洞，并得到交点

接下来需要根据交点，反推出一个方向上剖断线的点

### 2025年5月26日10:35:13

面配筋操作视频剪辑完成

演示视频操作流程：

1. 录制完整的功能操作视频，每个操作之间略微停顿方便分割讲解；
2. 导入到剪映视频工作台中；
3. 将原先的音轨分离并删除，消除可能的影响；
4. 将操作中长时间的加载过程剪掉；
5. 根据视频进度在记事本完成字幕，再添加到剪映中，并使用AI配音（使用已收藏的标准配音音色）；

### 2025年5月26日14:12:51

通过定义指针点，初始为起点，每次遭遇孔洞就将指针点和孔洞第一个点作为剖断线段，并更新指针点到孔洞第二个点作为新的剖断线段起点继续处理剩下的孔洞

使用lambda表达式统一处理上下左右的剖断线。

待处理圆孔：

首先确认所有调用CreateAllDash的地方如何生成孔洞，如果能找到圆孔就加入圆孔，如果没有则定义一个空的传入即可。

- [ ] ArcWallGraph
- [x] CellNameWallEmbededPartGraph
- [x] CellNameWallTemGraph
- [ ] GenerateArcwallByMidLine
- [ ] GenerateArcwallEmbByMidLine
- [x] GenerateGwallByMidLine
- [x] GWallEmbededPartGraph
- [x] GWallTemGraph
- [x] STWallEmbededPartGraph：使用了局部变量，还需要额外调查

### 2025年5月26日15:07:08

有可能上下并没有平行墙，仅有垂直墙，则剖断线应该只切到垂直墙而不是最大剖断线范围

核心思维：

剖断线需要剖断切到的墙，并避开空的位置

思路：

那么应该根据切到墙的位置都设定剖断线，最后排除遇到孔洞的位置

### 2025年5月26日18:00:02

先将剖断线范围内的所有墙都进行求交点，融合为完整的剖断线组。

问题：有一个带孔的墙无法得到交点，已发帖待回复



## 2025年5月27日

**优化 #85445**【核岛出图ABD】剖断线优化：在混凝土连续位置使用一段剖断线，若墙体被孔洞断开，使用多段剖断线

### 2025年5月27日11:34:54

可以用射线求交的方式拿到交点，但是出现了一面无孔洞的墙却有五个交点的异常情况

### 2025年5月27日16:50:15

使用mdlIntersect_allBetweenElms2可以处理Cell复杂形状，有孔洞的墙可以拿到理想的交点。

处理的上下墙是带有孔洞的，可以拿到与孔洞的交点，按偶数交点取起止点后，不再需要额外处理与孔洞组的交点。

基本解决大部分情况。

但是上下墙仅存储了墙中心切割得到的部分，模板图实际会前后扩大一定范围作图，如果刚好下方是一个凹型的墙，则上下墙中无法得到，而在wallshap墙主轮廓会有这个墙

### 2025年5月27日17:56:47

需要按照出图的轮廓来绘制剖断线

方案1：

尝试根据通过wallshap修改剖断线分段，影响小，但是操作度似乎较高。

方案2：

修改upwall和downwall的获取逻辑，改为与wallshap相同，都要前后移动些许，影响较大，可能要在多处修改



## 2025年5月28日

**优化 #85445**【核岛出图ABD】剖断线优化：在混凝土连续位置使用一段剖断线，若墙体被孔洞断开，使用多段剖断线

### 2025年5月28日09:48:16

方案3：原先在处理墙轮廓线得到剖断线时，就已经可以取到所有垂直墙的切线线段，将原先的逻辑加入到新的根据上下墙元素取剖断线逻辑中，线段融合后不影响效果，且补足了上下墙没有切到前后的一部分墙体。

### 2025年5月28日11:25:40

修复对上下无标注埋件的影响

"flag怪"为了处理上下埋件，在选中的墙有埋件时，把所有的上下墙孔洞埋件等元素全部排除了。

找到处理埋件的逻辑，分析如何加入埋件

### 2025年5月28日14:11:17

上下埋件修改：

CellNameWallEmbededPartGraph.cpp：

增加全局变量allnodimelement；//所有不需要标注的埋件内容

可能修改了CreateNoteDimEmbed内容

GenerateGwallByMidLine.cpp：

主要修改了ProjectWallsToMidFace，在中间墙孔洞投影基础上增加了上下墙孔洞投影

GraphCommon.cpp：

CalculatParalleWallProjectFacesAndHoles修改较多

CombineProjectHolesWithDottedLine

CombineProjectHoles

### 2025年5月28日17:08:47

修改is_dimembed参数实际并没有显著影响到上下埋件，简单测试下没有发现问题。是目前选择的构件不合适，上下切割范围内并没有埋件。



## 2025年5月29日

企口墙钢筋延伸到了盖板中

企口墙横筋延伸到了空处

### 2025年5月29日10:29:19

在每根钢筋单独计算延伸长度时，如果没有接触到则会使用组内默认的延伸长度。则可能延伸到空处。

### 2025年5月29日16:17:05

处理企口墙横筋延伸到了空处：

取消出自“flag怪”的每根钢筋计算延伸长度时无效固定初始值的墙体关系判断。

增加保底机制，每根钢筋延伸一定至少能有一个交点，即选中构件的边缘位置。

对于钢筋延伸到了盖板中：

一方面钢筋会延伸到板中是固定的特性，盖板并没有特殊的排除属性。

另一方面出现了断开的钢筋，是因为企口的孔洞导致了断开



## 2025年5月30日

企口墙锚固到盖板

### 2025年5月30日14:43:25

盖板归属于一个，可以通过排除隐藏的dgn在锚固时避开盖板

甲方希望可以根据层位，即类似结构命名时的4、5位数字来区分，盖板与墙的层位不同。但是梁和盖板在同一层位，而梁是需要锚固的。建议是盖板设定独立的Type，客户目前未回复。

问题：

原生的mdlElmdscr_computeRange出现计算问题，底板本应该在2889-3300范围，但是只取到了2889-2952，这是底板上方倾斜的最低最高范围。尝试新建文件并重新导入，仍然有问题。

### 2025年5月30日16:27:40

剖断线使用mdlIntersect_allBetweenElms2出现问题，容差没有生效，即使距离不超过0.1mm，仍然没有交点。

手动进行容差位移，根据剖断线位置向内偏移去交点，最后交点还原偏移。

模板图出现了埋件，基于“flag怪“的上下埋件改动，还原他的改动，暂时不需要孔洞信息。

### 2025年5月30日17:26:18

企口墙：盖板处理待回复；底板range有问题。

尺寸标注：根据图纸总结规律，待开会讨论优化。

### 2025年5月30日18:00:35

BFX2002VB边缘有斜墙，正反面模板图不同
